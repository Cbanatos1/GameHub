<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gaming Squad Hub</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Font Awesome -->
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
        body {
            background-color: #0f172a;
            color: #e5e7eb;
        }

        .modal-backdrop {
            background: rgba(15, 23, 42, 0.9);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen">

<!-- 用戶名選擇 POPUP -->
<div
    id="user-modal"
    class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50"
>
    <div
        class="bg-slate-800 border border-slate-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl"
    >
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <i class="fa-solid fa-user-astronaut text-sky-400"></i>
            <span>選擇你的用戶名</span>
        </h2>
        <p class="text-xs text-slate-400 mb-3">
            方便大家統一記錄約戰、投票同戰犯分數。
        </p>

        <label class="block text-sm mb-2 text-slate-300">隊員：</label>
        <select
            id="userSelect"
            class="w-full mb-3 px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-600 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
        ></select>

        <input
            id="userCustom"
            type="text"
            placeholder="如果揀「自訂」，喺呢度輸入名稱"
            class="w-full mb-4 px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-600 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 hidden"
        />

        <button
            onclick="confirmUser()"
            class="w-full py-2 rounded-lg bg-sky-500 hover:bg-sky-400 text-slate-900 font-semibold text-sm"
        >
            開始使用
        </button>
    </div>
</div>

<div class="max-w-6xl mx-auto py-6 px-4 space-y-8">
    <!-- 頂部 Header -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-extrabold flex items-center gap-3">
                <span
                    class="inline-flex h-9 w-9 rounded-xl bg-sky-500/20 items-center justify-center"
                >
                    <i class="fa-solid fa-gamepad text-sky-400"></i>
                </span>
                <span>Gaming Squad Hub</span>
            </h1>
            <p class="text-xs md:text-sm text-slate-400 mt-2">
                同一頁搞掂約戰月曆、Steam 遊戲投票同戰犯榜。
            </p>
        </div>

        <div class="flex flex-col items-start md:items-end gap-2">
            <div class="flex items-center gap-2 text-sm">
                <span class="text-slate-400">目前用戶：</span>
                <span id="currentUserDisplay" class="font-semibold text-sky-300">
                    （未設定）
                </span>
                <button
                    onclick="openUserModal(true)"
                    class="px-2 py-1 rounded-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-[11px] text-slate-200"
                >
                    更改
                </button>
            </div>

            <!-- 顯示用戶時區 -->
            <div id="timezoneNotice" class="text-[11px] text-slate-500"></div>

            <div class="flex flex-wrap gap-2 text-[11px] text-slate-400">
                <span
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-800/70 border border-slate-700/80"
                >
                    <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                    即時同步（Firestore）
                </span>
                <span
                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-800/70 border border-slate-700/80"
                >
                    <i class="fa-brands fa-discord text-indigo-400"></i>
                    5 人即自動 @everyone
                </span>
            </div>
        </div>
    </header>

    <!-- 主內容：三個功能在同一頁 -->
    <main class="space-y-10">
        <!-- 約戰月曆 -->
        <section
            id="scheduleSection"
            class="bg-slate-800/70 rounded-2xl p-4 md:p-6 shadow-xl border border-slate-700/70"
        >
            <div
                class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4"
            >
                <div>
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-calendar-days text-blue-400"></i>
                        <span>約戰月曆</span>
                    </h2>
                    <p class="text-xs text-slate-400 mt-1">
                        點日子 → 下面自由揀時間建立房間（每房最多 5 人，跨時區自動同步）。
                    </p>
                </div>

                <div class="flex items-center gap-2">
                    <button
                        onclick="changeMonth(-1)"
                        class="w-8 h-8 rounded-full bg-slate-900 hover:bg-slate-700 flex items-center justify-center text-slate-200 text-sm"
                    >
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div id="monthLabel" class="font-semibold text-sm md:text-base"></div>
                    <button
                        onclick="changeMonth(1)"
                        class="w-8 h-8 rounded-full bg-slate-900 hover:bg-slate-700 flex items-center justify-center text-slate-200 text-sm"
                    >
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- 星期標題 -->
            <div
                class="grid grid-cols-7 gap-1 text-[11px] text-center text-slate-400 mb-2"
            >
                <div>日</div>
                <div>一</div>
                <div>二</div>
                <div>三</div>
                <div>四</div>
                <div>五</div>
                <div>六</div>
            </div>

            <!-- 月曆格 -->
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm mb-5"></div>

            <!-- 當日詳細時段 -->
            <div
                class="grid md:grid-cols-[minmax(0,2fr)_minmax(0,1.4fr)] gap-5"
            >
                <div>
                    <h3
                        id="dayLabel"
                        class="font-semibold text-slate-100 mb-2 text-sm md:text-base"
                    ></h3>

                    <div
                        class="flex flex-col sm:flex-row sm:items-center gap-2 mb-3"
                    >
                        <input
                            id="newSlotTime"
                            type="time"
                            class="px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-600 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 w-full sm:w-32"
                        />
                        <input
                            id="newSlotNote"
                            type="text"
                            placeholder="備註（例如：Rank / 地圖 / 遊戲）"
                            class="flex-1 px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-600 text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                        />
                        <button
                            onclick="createSlot()"
                            class="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 text-xs sm:text-sm font-semibold whitespace-nowrap"
                        >
                            建立時段
                        </button>
                    </div>

                    <div id="daySlots" class="space-y-2 text-sm"></div>
                </div>

                <div
                    class="border-t md:border-t-0 md:border-l border-slate-700/70 pt-3 md:pt-0 md:pl-4 text-[11px] text-slate-400 space-y-2"
                >
                    <p class="font-semibold text-slate-200 text-sm">使用說明</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>上面月曆係用你本地時區顯示。</li>
                        <li>
                            同一房間實際時間用 UTC 儲存，其他時區玩家會自動換算成本地時間。
                        </li>
                        <li>
                            你已經加入嘅房間，再按一次就會「取消報名」。
                        </li>
                        <li>
                            只有<strong>建立該時段嘅人</strong>可以修改／刪除個房。
                        </li>
                        <li>
                            當某個時段由
                            <span class="text-yellow-300 font-semibold">4 → 5 人</span>，
                            會向 Discord Webhook 發送提示（時間用 UTC 顯示）。
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Steam 遊戲投票 -->
        <section
            id="voteSection"
            class="bg-slate-800/70 rounded-2xl p-4 md:p-6 shadow-xl border border-slate-700/70"
        >
            <div
                class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4"
            >
                <div>
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-brands fa-steam text-sky-300"></i>
                        <span>Steam Link 投票</span>
                    </h2>
                    <p class="text-xs text-slate-400 mt-1">
                        貼上 Steam 商店連結 → 自動抓遊戲封面 / 簡介 / 價錢，並自動幫你投一票。
                    </p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-3 mb-4">
                <input
                    id="steamUrlInput"
                    type="url"
                    placeholder="貼上 Steam 遊戲連結，例如：https://store.steampowered.com/app/730/CounterStrike_2/"
                    class="flex-1 px-3 py-2 rounded-lg bg-slate-900/80 border border-slate-600 text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-sky-500"
                />
                <button
                    id="steamAddBtn"
                    onclick="addSteamGame()"
                    class="px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-400 text-slate-900 text-xs md:text-sm font-semibold whitespace-nowrap flex items-center gap-2"
                >
                    <span id="steamAddBtnIcon" class="fa-solid fa-plus"></span>
                    <span>新增 & 投票</span>
                </button>
            </div>

            <div id="votes-container" class="space-y-3 text-sm"></div>
        </section>

        <!-- 戰犯榜 -->
        <section
            id="shameSection"
            class="bg-slate-800/70 rounded-2xl p-4 md:p-6 shadow-xl border border-slate-700/70"
        >
            <div
                class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3"
            >
                <div>
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-skull-crossbones text-red-400"></i>
                        <span>戰犯榜</span>
                    </h2>
                    <p class="text-xs text-slate-400 mt-1">
                        每位玩家對同一個人，每 24 小時只可以投 + / - 一次。
                    </p>
                </div>
            </div>

            <div id="shame-container" class="space-y-2 text-sm"></div>
        </section>
    </main>
</div>

<script>
    // === Firebase 設定 ===
    const firebaseConfig = {
        apiKey: "AIzaSyCai4pgh9UZTzkAyXt5cXna_wiEmX8z668",
        authDomain: "gamehub-394ee.firebaseapp.com",
        projectId: "gamehub-394ee",
        storageBucket: "gamehub-394ee.firebasestorage.app",
        messagingSenderId: "969481365716",
        appId: "1:969481365716:web:0d6396e14fbffe89747341",
        measurementId: "G-5ZXBF1SYLK",
    };

    const USERS = ["葉嘉宏", "鄭煒楠", "呂健朗", "張日朗", "梁啟維"];

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === 全域狀態 ===
    let currentUser = localStorage.getItem("currentUser") || null;

    // availabilityDocs: [{ id, startAtMs, note, participants, owner }]
    let availabilityDocs = [];
    let votesDocs = [];
    let shameMap = {};

    let selectedDate = formatDate(new Date()); // 今日（本地）
    let currentMonth = new Date();
    currentMonth.setDate(1);

    let listenersStarted = false;

    // === 工具函數 ===
    function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
    }

    function parseDate(dateStr) {
        const [y, m, d] = dateStr.split("-").map(Number);
        return new Date(y, m - 1, d);
    }

    function weekdayLabel(dateStr) {
        const d = parseDate(dateStr);
        const names = ["日", "一", "二", "三", "四", "五", "六"];
        return `(${names[d.getDay()]})`;
    }

    function escapeHtml(str) {
        if (!str) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    // 該本地日子的起止毫秒
    function getDayRangeMs(dateStr) {
        const [y, m, d] = dateStr.split("-").map(Number);
        const start = new Date(y, m - 1, d, 0, 0, 0, 0);
        const end = new Date(y, m - 1, d, 23, 59, 59, 999);
        return { startMs: start.getTime(), endMs: end.getTime() };
    }

    function formatLocalTimeFromMs(ms) {
        const d = new Date(ms);
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
    }

    function formatUtcLabel(ms) {
        const d = new Date(ms);
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth() + 1).padStart(2, "0");
        const day = String(d.getUTCDate()).padStart(2, "0");
        const hh = String(d.getUTCHours()).padStart(2, "0");
        const mm = String(d.getUTCMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm} (UTC)`;
    }

    // === 用戶名 Modal ===
    function openUserModal(isEdit) {
        const modal = document.getElementById("user-modal");
        const select = document.getElementById("userSelect");
        const custom = document.getElementById("userCustom");

        select.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "請選擇一個用戶名";
        select.appendChild(placeholder);

        USERS.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            if (isEdit && currentUser === name) opt.selected = true;
            select.appendChild(opt);
        });

        const optCustom = document.createElement("option");
        optCustom.value = "_custom";
        optCustom.textContent = "其他 / 自訂";
        if (isEdit && currentUser && !USERS.includes(currentUser)) {
            optCustom.selected = true;
            custom.classList.remove("hidden");
            custom.value = currentUser;
        } else {
            custom.classList.add("hidden");
            custom.value = "";
        }
        select.appendChild(optCustom);

        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function hideUserModal() {
        const modal = document.getElementById("user-modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    document.addEventListener("change", (e) => {
        if (e.target.id === "userSelect") {
            const custom = document.getElementById("userCustom");
            if (e.target.value === "_custom") {
                custom.classList.remove("hidden");
            } else {
                custom.classList.add("hidden");
            }
        }
    });

    function confirmUser() {
        const select = document.getElementById("userSelect");
        const custom = document.getElementById("userCustom");

        let name = select.value;
        if (name === "_custom") {
            name = custom.value.trim();
        }

        if (!name) {
            alert("請先選擇或輸入一個用戶名。");
            return;
        }

        currentUser = name;
        localStorage.setItem("currentUser", currentUser);

        const display = document.getElementById("currentUserDisplay");
        if (display) display.textContent = currentUser;

        hideUserModal();

        if (!listenersStarted) {
            startRealtimeListeners();
        } else {
            renderDaySlots();
            renderVotes();
            renderShame();
        }
    }

    // === 月曆渲染 ===
    function renderCalendar() {
        const grid = document.getElementById("calendarGrid");
        if (!grid) return;

        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();

        const firstDay = new Date(year, month, 1);
        const firstWeekday = firstDay.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        document.getElementById("monthLabel").textContent = `${year}年${
            month + 1
        }月`;

        const todayStr = formatDate(new Date());
        grid.innerHTML = "";

        const totalCells = 42; // 6 weeks
        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement("button");
            cell.type = "button";

            const dayNum = i - firstWeekday + 1;
            if (dayNum < 1 || dayNum > daysInMonth) {
                cell.className =
                    "h-10 md:h-12 rounded-lg text-xs bg-slate-900/40 border border-slate-800/50";
                grid.appendChild(cell);
                continue;
            }

            const dateObj = new Date(year, month, dayNum);
            const dateStr = formatDate(dateObj);
            const { startMs, endMs } = getDayRangeMs(dateStr);

            const hasSlots = availabilityDocs.some(
                (s) => s.startAtMs >= startMs && s.startAtMs <= endMs
            );

            const isToday = dateStr === todayStr;
            const isSelected = dateStr === selectedDate;

            let baseClass =
                "h-10 md:h-12 w-full rounded-lg border text-xs md:text-sm flex flex-col items-center justify-center transition-colors ";
            if (isSelected) {
                baseClass +=
                    "bg-sky-500 text-slate-900 border-sky-400";
            } else if (isToday) {
                baseClass +=
                    "bg-slate-900 text-sky-300 border-sky-500/60";
            } else {
                baseClass +=
                    "bg-slate-900/60 text-slate-200 border-slate-700 hover:bg-slate-800";
            }

            cell.className = baseClass;
            cell.dataset.date = dateStr;
            cell.onclick = () => {
                selectedDate = dateStr;
                renderCalendar();
                renderDaySlots();
            };

            cell.innerHTML = `
                <div class="text-xs md:text-sm font-semibold">${dayNum}</div>
                <div class="mt-0.5 flex items-center gap-1">
                    ${hasSlots ? '<span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>' : ""}
                    ${isToday ? '<span class="text-[10px] text-sky-300">今</span>' : ""}
                </div>
            `;

            grid.appendChild(cell);
        }

        const dayLabel = document.getElementById("dayLabel");
        if (dayLabel) {
            dayLabel.textContent = `${selectedDate} ${weekdayLabel(
                selectedDate
            )} 的房間（時間以你本地時區顯示）`;
        }
    }

    function changeMonth(delta) {
        currentMonth.setMonth(currentMonth.getMonth() + delta);
        renderCalendar();
        renderDaySlots();
    }

    // === 約戰：建立 & 列表 ===
    async function createSlot() {
        if (!currentUser) {
            alert("請先設定用戶名。");
            openUserModal(false);
            return;
        }

        const timeInput = document.getElementById("newSlotTime");
        const noteInput = document.getElementById("newSlotNote");
        const timeVal = (timeInput.value || "").trim();

        if (!timeVal) {
            alert("請先選擇時間（HH:MM）。");
            return;
        }

        const localDateTime = new Date(`${selectedDate}T${timeVal}:00`);
        const startAtMs = localDateTime.getTime();
        if (Number.isNaN(startAtMs)) {
            alert("時間格式有問題，請重新輸入。");
            return;
        }

        const slotId = String(startAtMs);
        const note = (noteInput.value || "").trim();

        try {
            await toggleAvailability(slotId, startAtMs, note, true);
            noteInput.value = "";
        } catch (e) {
            console.error(e);
            alert("建立時段時出現問題，請稍後再試。");
        }
    }

    async function toggleAvailability(slotId, startAtMs, note, allowCreate) {
        if (!currentUser) {
            alert("請先設定用戶名。");
            openUserModal(false);
            return;
        }

        const docRef = db.collection("availability").doc(slotId);

        const result = await db.runTransaction(async (tx) => {
            const doc = await tx.get(docRef);
            let data;

            if (!doc.exists) {
                if (!allowCreate) return null;

                const d = new Date(startAtMs);
                if (Number.isNaN(d.getTime())) {
                    throw new Error("Invalid startAtMs when creating slot");
                }

                data = {
                    startAt: firebase.firestore.Timestamp.fromDate(d),
                    startAtMs: startAtMs,
                    note: note || "",
                    participants: [],
                    owner: currentUser,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                };
            } else {
                data = doc.data() || {};

                // 舊資料兼容
                if (!data.startAtMs) {
                    if (
                        data.startAt &&
                        typeof data.startAt.toDate === "function"
                    ) {
                        data.startAtMs = data.startAt.toDate().getTime();
                    } else if (data.date && data.time) {
                        const fb = new Date(
                            `${data.date}T${data.time || "00:00"}:00`
                        );
                        data.startAtMs = fb.getTime();
                        data.startAt =
                            firebase.firestore.Timestamp.fromDate(fb);
                    } else if (startAtMs) {
                        const d = new Date(startAtMs);
                        data.startAtMs = d.getTime();
                        data.startAt =
                            firebase.firestore.Timestamp.fromDate(d);
                    }
                }

                if (!data.owner) {
                    // 舊 slot 沒 owner，就當第一次操作嘅人係 owner
                    data.owner = currentUser;
                }

                if (note && note.trim()) {
                    data.note = note;
                }
                if (!Array.isArray(data.participants)) {
                    data.participants = [];
                }
            }

            const oldParticipants = data.participants || [];
            const oldCount = oldParticipants.length;

            let newParticipants;
            if (oldParticipants.includes(currentUser)) {
                newParticipants = oldParticipants.filter(
                    (p) => p !== currentUser
                );
            } else {
                newParticipants = [...oldParticipants, currentUser];
            }
            const newCount = newParticipants.length;

            data.participants = newParticipants;

            tx.set(docRef, data, { merge: true });

            return {
                oldCount,
                newCount,
                startAtMs: data.startAtMs,
            };
        });

        if (result && result.oldCount < 5 && result.newCount >= 5) {
            const label = formatUtcLabel(result.startAtMs);
            try {
                await notifyDiscord(label);
            } catch (e) {
                console.error("Discord 通知失敗：", e);
            }
        }
    }

    function renderDaySlots() {
        const container = document.getElementById("daySlots");
        if (!container) return;

        const { startMs, endMs } = getDayRangeMs(selectedDate);

        const daySlots = availabilityDocs
            .filter(
                (s) => s.startAtMs >= startMs && s.startAtMs <= endMs
            )
            .sort((a, b) => a.startAtMs - b.startAtMs);

        if (!daySlots.length) {
            container.innerHTML = `<p class="text-slate-500 text-xs md:text-sm py-2">
                今日暫時未有房間，可以用上面「建立時段」開新房。
            </p>`;
            return;
        }

        container.innerHTML = daySlots
            .map((slot) => {
                const participants = slot.participants || [];
                const count = participants.length;
                const isJoined =
                    currentUser && participants.includes(currentUser);
                const isFull = count >= 5 && !isJoined;
                const isOwner = currentUser && slot.owner === currentUser;

                const btnText = isJoined
                    ? "取消報名"
                    : isFull
                    ? "已額滿"
                    : "我要加入";
                const btnClass = isJoined
                    ? "bg-rose-500 hover:bg-rose-400 text-slate-900"
                    : isFull
                    ? "bg-slate-700 text-slate-400 cursor-not-allowed"
                    : "bg-emerald-500 hover:bg-emerald-400 text-slate-900";

                const noteHtml = slot.note
                    ? `<div class="text-[11px] text-slate-300">${escapeHtml(
                          slot.note
                      )}</div>`
                    : "";

                const timeText = formatLocalTimeFromMs(slot.startAtMs);

                const ownerHtml = slot.owner
                    ? `<div class="text-[10px] text-slate-500">建立者：${escapeHtml(
                          slot.owner
                      )}</div>`
                    : "";

                const manageHtml = isOwner
                    ? `
                        <div class="flex gap-1 mt-1 justify-end">
                            <button
                                class="px-2 py-1 rounded-full bg-slate-800 hover:bg-slate-700 text-[11px]"
                                onclick="editSlot('${slot.id}')"
                            >
                                修改
                            </button>
                            <button
                                class="px-2 py-1 rounded-full bg-rose-600 hover:bg-rose-500 text-[11px]"
                                onclick="deleteSlot('${slot.id}')"
                            >
                                刪除
                            </button>
                        </div>
                    `
                    : "";

                return `
                <div class="bg-slate-900/60 border border-slate-700/80 rounded-xl p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <div class="space-y-1">
                        <div class="font-mono text-sm text-sky-300">${timeText}</div>
                        ${noteHtml}
                        <div class="text-[11px] text-slate-400">
                            玩家（${count}/5）：
                            ${
                                participants.length
                                    ? escapeHtml(
                                          participants.join("、")
                                      )
                                    : "暫時未有人加入"
                            }
                        </div>
                        ${ownerHtml}
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        ${
                            isFull
                                ? '<span class="text-[10px] text-yellow-400 font-bold">FULL SQUAD</span>'
                                : ""
                        }
                        <button
                            class="px-3 py-1.5 rounded-lg text-xs font-semibold ${btnClass}"
                            ${isFull ? "disabled" : ""}
                            onclick="toggleAvailability('${
                                slot.id
                            }', ${slot.startAtMs}, '', false)"
                        >
                            ${btnText}
                        </button>
                        ${manageHtml}
                    </div>
                </div>
            `;
            })
            .join("");
    }

    async function editSlot(slotId) {
        if (!currentUser) {
            alert("請先設定用戶名。");
            openUserModal(false);
            return;
        }
        const slot = availabilityDocs.find((s) => s.id === slotId);
        if (!slot) {
            alert("找不到這個時段，可能已被刪除。");
            return;
        }
        if (slot.owner && slot.owner !== currentUser) {
            alert("只有建立呢個時段的人先可以修改。");
            return;
        }

        const currentTime = formatLocalTimeFromMs(slot.startAtMs);
        const currentNote = slot.note || "";

        const newTime = prompt(
            "輸入新時間（24 小時制 HH:MM）：",
            currentTime
        );
        if (newTime === null) return; // user cancelled
        const timeTrim = newTime.trim();
        if (!/^\d{2}:\d{2}$/.test(timeTrim)) {
            alert("時間格式唔正確，請用 HH:MM，例如 20:30。");
            return;
        }

        const newNote = prompt(
            "輸入新備註（可以留空）：",
            currentNote
        );
        if (newNote === null) return;

        // 計算新時間（保留原本日期）
        const d = new Date(slot.startAtMs);
        const [hh, mm] = timeTrim.split(":").map(Number);
        const newDate = new Date(
            d.getFullYear(),
            d.getMonth(),
            d.getDate(),
            hh,
            mm,
            0,
            0
        );
        const newStartAtMs = newDate.getTime();

        const oldId = slot.id;
        const newId = String(newStartAtMs);

        try {
            await db.runTransaction(async (tx) => {
                const oldRef = db.collection("availability").doc(oldId);
                const oldSnap = await tx.get(oldRef);
                if (!oldSnap.exists) {
                    throw new Error("NOT_FOUND");
                }
                const oldData = oldSnap.data() || {};
                if (oldData.owner && oldData.owner !== currentUser) {
                    throw new Error("NOT_OWNER");
                }

                // 只改備註 & 時間
                const dataToMove = { ...oldData };
                dataToMove.note = newNote.trim();
                dataToMove.startAtMs = newStartAtMs;
                dataToMove.startAt =
                    firebase.firestore.Timestamp.fromDate(newDate);

                if (newId === oldId) {
                    // 只修改內容
                    tx.set(oldRef, dataToMove, { merge: true });
                } else {
                    const newRef = db.collection("availability").doc(newId);
                    const newSnap = await tx.get(newRef);
                    if (newSnap.exists) {
                        throw new Error("TIME_CONFLICT");
                    }
                    tx.set(newRef, dataToMove);
                    tx.delete(oldRef);
                }
            });
        } catch (e) {
            console.error(e);
            if (e.message === "NOT_OWNER") {
                alert("只有建立呢個時段的人先可以修改。");
            } else if (e.message === "TIME_CONFLICT") {
                alert("你改後嘅時間已經有另一個時段使用，請改其他時間。");
            } else if (e.message !== "NOT_FOUND") {
                alert("修改時段失敗，請稍後再試。");
            }
        }
    }

    async function deleteSlot(slotId) {
        if (!currentUser) {
            alert("請先設定用戶名。");
            openUserModal(false);
            return;
        }
        if (!confirm("確定要刪除呢個時段？所有報名都會一齊刪除。")) {
            return;
        }

        const ref = db.collection("availability").doc(slotId);
        try {
            const snap = await ref.get();
            if (!snap.exists) return;
            const data = snap.data() || {};
            if (data.owner && data.owner !== currentUser) {
                alert("只有建立呢個時段的人先可以刪除。");
                return;
            }
            await ref.delete();
        } catch (e) {
            console.error(e);
            alert("刪除時段失敗，請稍後再試。");
        }
    }

    // === Discord 通知 ===
    async function notifyDiscord(slotLabel) {
        const res = await fetch("/.netlify/functions/discord", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ slotName: slotLabel }),
        });
        if (!res.ok) {
            throw new Error(
                "Discord webhook 回傳錯誤：" + (await res.text())
            );
        }
    }

    // === Steam 投票 ===
    function renderVotes() {
        const container = document.getElementById("votes-container");
        if (!container) return;

        if (!votesDocs.length) {
            container.innerHTML = `<p class="text-slate-500 text-xs md:text-sm py-2">
                暫時未有任何遊戲，可以貼 Steam 連結新增。
            </p>`;
            return;
        }

        const sorted = [...votesDocs].sort(
            (a, b) => (b.count || 0) - (a.count || 0)
        );

        container.innerHTML = sorted
            .map((game) => {
                const count = game.count || 0;
                const voters = game.voters || [];
                const hasVoted =
                    currentUser && voters.includes(currentUser);

                const votersText = voters.length
                    ? escapeHtml(voters.join("、"))
                    : "暫時無";

                return `
                <div class="bg-slate-800/70 rounded-2xl overflow-hidden border border-slate-700/80 flex flex-col md:flex-row">
                    <div class="md:w-40 md:h-24 bg-slate-900/80 flex items-center justify-center overflow-hidden">
                        ${
                            game.headerImage
                                ? `<img src="${game.headerImage}" alt="${escapeHtml(
                                      game.name || ""
                                  )}" class="w-full h-full object-cover">`
                                : `<span class="text-[11px] text-slate-500">無封面</span>`
                        }
                    </div>
                    <div class="flex-1 p-3 md:p-4 flex flex-col gap-2">
                        <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                                <a href="${
                                    game.url || "#"
                                }" target="_blank"
                                   class="font-semibold text-sm md:text-base text-sky-300 hover:underline break-words">
                                    ${escapeHtml(game.name || "未命名遊戲")}
                                </a>
                                <div class="text-[11px] md:text-xs text-slate-400 mt-1 line-clamp-2">
                                    ${escapeHtml(
                                        game.shortDescription || ""
                                    )}
                                </div>
                            </div>
                            <div class="text-right text-xs whitespace-nowrap">
                                <div class="font-bold text-emerald-300">
                                    ${escapeHtml(game.priceText || "")}
                                </div>
                                <div class="text-[10px] text-slate-500 mt-1">
                                    票數：${count}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between gap-3 text-xs mt-1">
                            <div class="flex-1 text-[11px] text-slate-400 truncate">
                                支持者：${votersText}
                            </div>
                            <div class="flex items-center gap-2">
                                <button
                                    class="px-3 py-1 rounded-full text-xs font-semibold ${
                                        hasVoted
                                            ? "bg-emerald-500 text-slate-900"
                                            : "bg-slate-700 text-slate-100 hover:bg-slate-600"
                                    }"
                                    onclick="toggleVote('${game.id}')"
                                >
                                    ${hasVoted ? "已投" : "投票"}
                                </button>
                                <button
                                    class="p-1 rounded-full text-slate-500 hover:text-red-400 hover:bg-slate-700"
                                    onclick="deleteGame('${game.id}')"
                                    title="刪除遊戲"
                                >
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            })
            .join("");
    }

    async function addSteamGame() {
        if (!currentUser) {
            alert("請先設定用戶名。");
            openUserModal(false);
            return;
        }

        const input = document.getElementById("steamUrlInput");
        const btn = document.getElementById("steamAddBtn");
        const icon = document.getElementById("steamAddBtnIcon");
        const url = (input.value || "").trim();

        if (!url) {
            alert("請先貼上 Steam 遊戲連結。");
            return;
        }

        const match = url.match(/\/app\/(\d+)/);
        if (!match) {
            alert(
                "未能從連結中找到 appid，請確認係 Steam 遊戲頁面 URL。"
            );
            return;
        }
        const appId = match[1];

        btn.disabled = true;
        icon.classList.remove("fa-plus");
        icon.classList.add("fa-spinner", "fa-spin");

        try {
            const resp = await fetch("/.netlify/functions/steam", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ appId, url }),
            });

            if (!resp.ok) {
                throw new Error(
                    "Steam metadata function 返回錯誤：" +
                        (await resp.text())
                );
            }

            const meta = await resp.json();
            const docRef = db.collection("votes").doc(meta.appId);

            await db.runTransaction(async (tx) => {
                const doc = await tx.get(docRef);
                const base = {
                    appId: meta.appId,
                    url: meta.url,
                    name: meta.name,
                    headerImage: meta.headerImage,
                    shortDescription: meta.shortDescription,
                    priceText: meta.priceText,
                    createdAt:
                        firebase.firestore.FieldValue.serverTimestamp(),
                };

                if (!doc.exists) {
                    tx.set(docRef, {
                        ...base,
                        voters: [currentUser],
                        count: 1,
                    });
                } else {
                    const data = doc.data() || {};
                    const voters = Array.isArray(data.voters)
                        ? data.voters.slice()
                        : [];
                    let count = data.count || voters.length;

                    if (!voters.includes(currentUser)) {
                        voters.push(currentUser);
                        count += 1;
                    }

                    tx.set(
                        docRef,
                        {
                            ...data,
                            ...base,
                            voters,
                            count,
                        },
                        { merge: true }
                    );
                }
            });

            input.value = "";
        } catch (e) {
            console.error(e);
            alert(
                "讀取 Steam 資料失敗，請檢查 Netlify function（steam.js）設定，或稍後再試。"
            );
        } finally {
            btn.disabled = false;
            icon.classList.remove("fa-spinner", "fa-spin");
            icon.classList.add("fa-plus");
        }
    }

    async function toggleVote(gameId) {
        if (!currentUser) {
            alert("請先設定用戶名。");
            openUserModal(false);
            return;
        }

        const docRef = db.collection("votes").doc(gameId);
        await db.runTransaction(async (tx) => {
            const doc = await tx.get(docRef);
            if (!doc.exists) return;

            const data = doc.data() || {};
            let voters = Array.isArray(data.voters)
                ? data.voters.slice()
                : [];
            let count = data.count || 0;

            if (voters.includes(currentUser)) {
                voters = voters.filter((v) => v !== currentUser);
                count = Math.max(0, count - 1);
            } else {
                voters.push(currentUser);
                count += 1;
            }

            tx.update(docRef, { voters, count });
        });
    }

    async function deleteGame(gameId) {
        if (!confirm("確定要刪除呢隻遊戲嘅投票？")) return;
        await db.collection("votes").doc(gameId).delete();
    }

    // === 戰犯榜 ===
    function renderShame() {
        const container = document.getElementById("shame-container");
        if (!container) return;

        // 只顯示 USERS 陣列入面嗰幾個人，避免顯示 Firestore random ID
        const names = USERS.slice();

        if (!names.length) {
            container.innerHTML = `<p class="text-slate-500 text-xs md:text-sm py-2">
                暫時未有人上榜，可以用右邊按鈕加減分數。
            </p>`;
            return;
        }

        names.sort(
            (a, b) => (shameMap[b] || 0) - (shameMap[a] || 0)
        );

        container.innerHTML = names
            .map((name, idx) => {
                const score = shameMap[name] || 0;
                const top = idx === 0 && score > 0;

                const nameClass = top
                    ? "text-red-400 font-bold text-base"
                    : "text-slate-200";
                const scoreClass =
                    score > 0 ? "text-red-300" : "text-slate-400";

                return `
                <div class="bg-slate-900/60 border border-slate-700/80 rounded-xl p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="w-6 text-xs md:text-sm text-slate-500 font-mono">#${
                            idx + 1
                        }</span>
                        <span class="${nameClass}">${escapeHtml(name)}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold ${scoreClass}">${score}</span>
                        <div class="flex gap-1">
                            <button
                                class="w-8 h-8 rounded-full bg-slate-800 hover:bg-red-600 text-red-200 text-sm font-bold flex items-center justify-center"
                                onclick="updateShame('${name}', 1)"
                            >
                                +
                            </button>
                            <button
                                class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-600 text-slate-200 text-sm font-bold flex items-center justify-center"
                                onclick="updateShame('${name}', -1)"
                            >
                                -
                            </button>
                        </div>
                    </div>
                </div>
            `;
            })
            .join("");
    }

    async function updateShame(name, delta) {
        if (!currentUser) {
            alert("請先設定用戶名。");
            openUserModal(false);
            return;
        }

        const shameRef = db.collection("shame").doc(name);
        const voteRef = db
            .collection("shameVotes")
            .doc(`${name}__${currentUser}`);

        const COOLDOWN_MS = 24 * 60 * 60 * 1000;

        try {
            await db.runTransaction(async (tx) => {
                const voteSnap = await tx.get(voteRef);
                const nowMs = Date.now();

                if (voteSnap.exists) {
                    const vData = voteSnap.data() || {};
                    if (
                        vData.lastVoteAt &&
                        typeof vData.lastVoteAt.toDate === "function"
                    ) {
                        const lastMs =
                            vData.lastVoteAt.toDate().getTime();
                        if (nowMs - lastMs < COOLDOWN_MS) {
                            throw new Error("COOLDOWN");
                        }
                    }
                }

                tx.set(
                    shameRef,
                    {
                        count: firebase.firestore.FieldValue.increment(
                            delta
                        ),
                    },
                    { merge: true }
                );

                tx.set(
                    voteRef,
                    {
                        lastVoteAt:
                            firebase.firestore.Timestamp.fromMillis(
                                nowMs
                            ),
                    },
                    { merge: true }
                );
            });
        } catch (e) {
            console.error(e);
            if (e.message === "COOLDOWN") {
                alert(
                    "你已經對呢個玩家投過票，需等待 24 小時先可以再投。"
                );
            } else {
                alert("更新戰犯榜失敗，請稍後再試。");
            }
        }
    }

    // === Firestore 即時監聽 ===
    function startRealtimeListeners() {
        if (listenersStarted) return;
        listenersStarted = true;

        // 約戰
        db.collection("availability").onSnapshot((snap) => {
            availabilityDocs = snap.docs
                .map((d) => {
                    const data = d.data() || {};
                    let startAtMs = data.startAtMs;

                    if (!startAtMs) {
                        if (
                            data.startAt &&
                            typeof data.startAt.toDate === "function"
                        ) {
                            startAtMs = data.startAt
                                .toDate()
                                .getTime();
                        } else if (data.date && data.time) {
                            const fb = new Date(
                                `${data.date}T${
                                    data.time || "00:00"
                                }:00`
                            );
                            startAtMs = fb.getTime();
                        } else {
                            return null;
                        }
                    }

                    return {
                        id: d.id,
                        startAtMs,
                        note: data.note || "",
                        owner: data.owner || null,
                        participants: Array.isArray(data.participants)
                            ? data.participants
                            : [],
                    };
                })
                .filter(Boolean);

            renderCalendar();
            renderDaySlots();
        });

        // Steam 投票
        db.collection("votes").onSnapshot((snap) => {
            votesDocs = snap.docs.map((d) => ({
                id: d.id,
                ...d.data(),
            }));
            renderVotes();
        });

        // 戰犯榜
        db.collection("shame").onSnapshot((snap) => {
            const map = {};
            snap.forEach((d) => {
                const data = d.data() || {};
                map[d.id] = data.count || 0;
            });
            shameMap = map;
            renderShame();
        });
    }

    // === 初始化 ===
    document.addEventListener("DOMContentLoaded", () => {
        const display = document.getElementById("currentUserDisplay");
        if (currentUser && display) {
            display.textContent = currentUser;
        }

        // 顯示時區資訊
        const tzEl = document.getElementById("timezoneNotice");
        if (tzEl) {
            try {
                const tz =
                    Intl.DateTimeFormat().resolvedOptions().timeZone;
                const offsetMinutes = -new Date().getTimezoneOffset();
                const sign = offsetMinutes >= 0 ? "+" : "-";
                const absMin = Math.abs(offsetMinutes);
                const oh = String(
                    Math.floor(absMin / 60)
                ).padStart(2, "0");
                const om = String(absMin % 60).padStart(2, "0");
                tzEl.textContent = `你目前時區：${
                    tz || "未知"
                }（UTC${sign}${oh}:${om}）。頁面所有時間以「你本地時間」顯示；Discord 提示會以 UTC 顯示。`;
            } catch (e) {
                tzEl.textContent =
                    "頁面所有時間以你本地時間顯示；Discord 提示會以 UTC 顯示。";
            }
        }

        renderCalendar();
        renderDaySlots();
        renderVotes();
        renderShame();

        if (!currentUser) {
            openUserModal(false);
        } else {
            startRealtimeListeners();
        }
    });
</script>
</body>
</html>